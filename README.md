К сожалению, я прочитал примечания к реализации уже после того, как написал код, а сейчас уже пора спать.
